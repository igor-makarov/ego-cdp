#!/usr/bin/env node

const path = require('path');
const chrome = require('../lib/launch/chrome');
const caddy = require('../lib/launch/caddy');
const { isRunning, getProxyPort } = require('../lib/launch/common');
const { runHttpCommand } = require('../lib/cdp/http');

async function start() {
  const chromePid = chrome.getPid();
  const caddyPid = caddy.getPid();
  const chromeAlive = chromePid && isRunning(chromePid);
  const caddyAlive = caddyPid && isRunning(caddyPid);

  if (chromeAlive && caddyAlive) {
    console.log(`Already running (chrome ${chromePid}, caddy ${caddyPid}).`);
    return;
  }

  if (chromeAlive !== caddyAlive) {
    console.log('Partial state detected, restarting...');
    stop();
  }

  const cdpPort = await chrome.start();
  if (cdpPort) {
    caddy.start(getProxyPort(), cdpPort);
  }
}

function stop() {
  caddy.stop();
  chrome.stop();
}

async function status() {
  const chromePid = chrome.getPid();
  const caddyPid = caddy.getPid();

  if (!chromePid) {
    console.log('Chrome: no pid');
  } else {
    try {
      const info = JSON.parse(await runHttpCommand({ path: '/json/version' }));
      console.log(`Chrome: pid ${chromePid} — ${info.Browser}`);
    } catch {
      console.log(`Chrome: pid ${chromePid} — CDP not responding`);
    }
  }

  if (!caddyPid) {
    console.log('Caddy: no pid');
  } else {
    console.log(`Caddy: pid ${caddyPid}, proxy port ${getProxyPort()}`);
  }
}

const command = process.argv[2];
switch (command) {
  case 'start':  start();  break;
  case 'stop':   stop();   break;
  case 'status': status(); break;
  default:
    console.error(`Usage: ${path.basename(process.argv[1])} {start|stop|status}`);
    process.exit(1);
}
