#!/usr/bin/env node

const path = require('path');
const http = require('http');
const chrome = require('../lib/launch/chrome');
const caddy = require('../lib/launch/caddy');

const PROXY_PORT = parseInt(process.env.PORT, 10) || 9222;

async function start() {
  const cdpPort = await chrome.start();
  if (cdpPort) {
    caddy.start(PROXY_PORT, cdpPort);
  }
}

function stop() {
  caddy.stop();
  chrome.stop();
}

function status() {
  const pid = chrome.status();
  if (!pid) {
    console.log('Not running.');
    return;
  }

  const req = http.get(`http://cdp.test:${PROXY_PORT}/json/version`, (res) => {
    let data = '';
    res.on('data', (chunk) => data += chunk);
    res.on('end', () => {
      try {
        const info = JSON.parse(data);
        console.log(`Running (pid ${pid}) — ${info.Browser}`);
      } catch {
        console.log(`Running (pid ${pid}) — CDP not responding yet.`);
      }
    });
  });
  req.on('error', () => {
    console.log(`Running (pid ${pid}) — CDP not responding yet.`);
  });
  req.setTimeout(2000, () => {
    req.destroy();
    console.log(`Running (pid ${pid}) — CDP timed out.`);
  });
}

const command = process.argv[2];
switch (command) {
  case 'start':  start();  break;
  case 'stop':   stop();   break;
  case 'status': status(); break;
  default:
    console.error(`Usage: ${path.basename(process.argv[1])} {start|stop|status}`);
    process.exit(1);
}
