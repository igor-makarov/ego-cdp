#!/usr/bin/env node

import path from 'path';
import * as chrome from '../lib/launch/chrome.js';
import * as caddy from '../lib/launch/caddy.js';
import { isRunning } from '../lib/common/pid.js';
import { getProxyPort } from '../lib/common/config.js';
import { runHttpCommand } from '../lib/cdp/http.js';

async function start() {
  const chromePid = chrome.getPid();
  const caddyPid = caddy.getPid();
  const chromeAlive = chromePid && isRunning(chromePid);
  const caddyAlive = caddyPid && isRunning(caddyPid);

  if (chromeAlive && caddyAlive) {
    console.log(`Already running (chrome ${chromePid}, caddy ${caddyPid}).`);
    return;
  }

  if (chromeAlive !== caddyAlive) {
    console.log('Partial state detected, restarting...');
    stop();
  }

  const cdpPort = await chrome.start();
  if (cdpPort) {
    caddy.start(getProxyPort(), cdpPort);
  }
}

function stop() {
  caddy.stop();
  chrome.stop();
}

async function status() {
  const chromePid = chrome.getPid();
  const caddyPid = caddy.getPid();

  if (!chromePid) {
    console.log('Chrome: no pid');
  } else {
    try {
      const info = JSON.parse(await runHttpCommand({ path: '/json/version' }));
      console.log(`Chrome: pid ${chromePid} — ${info.Browser}`);
    } catch {
      console.log(`Chrome: pid ${chromePid} — CDP not responding`);
    }
  }

  if (!caddyPid) {
    console.log('Caddy: no pid');
  } else {
    console.log(`Caddy: pid ${caddyPid}, proxy port ${getProxyPort()}`);
  }
}

const command = process.argv[2];
switch (command) {
  case 'start':  start();  break;
  case 'stop':   stop();   break;
  case 'status': status(); break;
  default:
    console.error(`Usage: ${path.basename(process.argv[1])} {start|stop|status}`);
    process.exit(1);
}
